<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevOps Map</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: var(--vscode-font-family);
            background: var(--vscode-editor-background);
            color: var(--vscode-editor-foreground);
            overflow: hidden;
        }
        #map-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0;
            transition: transform 0.1s;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: var(--vscode-editor-background);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 250px;
            max-width: 300px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .control-group label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--vscode-editor-foreground);
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        button {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 6px 12px;
            margin: 2px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 11px;
        }
        button:hover {
            background: var(--vscode-button-hoverBackground);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        input[type="text"] {
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            padding: 4px 8px;
            border-radius: 2px;
            font-size: 11px;
        }
        input[type="text"]:focus {
            outline: 1px solid var(--vscode-focusBorder);
        }
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 200px;
            overflow-y: auto;
            padding: 6px;
            background: var(--vscode-editor-background);
            border: 1px solid var(--vscode-input-border);
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 3px;
            transition: background-color 0.15s;
        }
        .checkbox-item:hover {
            background: var(--vscode-list-hoverBackground);
        }
        .checkbox-item input[type="checkbox"] {
            cursor: pointer;
            margin: 0;
            width: 16px;
            height: 16px;
            accent-color: var(--vscode-textLink-foreground);
        }
        .checkbox-item label {
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            margin: 0;
            color: var(--vscode-editor-foreground);
            flex: 1;
            line-height: 1.4;
        }
        .filter-mode-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
            padding: 4px;
            background: var(--vscode-input-background);
            border-radius: 3px;
        }
        .filter-mode-toggle button {
            flex: 1;
            padding: 4px 8px;
            font-size: 10px;
            background: transparent;
            border: 1px solid var(--vscode-input-border);
        }
        .filter-mode-toggle button.active {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }
        .display-options {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .display-option-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .display-option-row label {
            font-size: 11px;
            font-weight: 500;
            margin: 0;
            flex: 1;
        }
        .display-option-row input[type="range"] {
            flex: 2;
        }
        .display-option-row select {
            flex: 2;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            padding: 4px 8px;
            border-radius: 2px;
            font-size: 11px;
        }
        .display-option-value {
            min-width: 40px;
            text-align: right;
            font-size: 10px;
            color: var(--vscode-descriptionForeground);
        }
        .zoom-controls {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .zoom-controls button {
            min-width: 30px;
            padding: 4px 8px;
        }
        .zoom-level {
            min-width: 50px;
            text-align: center;
            font-size: 11px;
        }
        .node {
            position: absolute;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.2s, opacity 0.2s;
            white-space: nowrap;
        }
        .node:hover {
            transform: scale(1.1);
            z-index: 100;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        .node.hidden {
            opacity: 0.2;
            pointer-events: none;
        }
        .node.highlighted {
            outline: 2px solid var(--vscode-textLink-foreground);
            outline-offset: 2px;
        }
        .node-account { background: var(--vscode-badge-background); }
        .node-project { background: var(--vscode-textBlockQuote-background); }
        .node-domain { background: var(--vscode-textCodeBlock-background); }
        .node-server { background: var(--vscode-inputValidation-infoBackground); }
        .node-record { background: var(--vscode-editor-inactiveSelectionBackground); }
        .connection {
            position: absolute;
            pointer-events: none;
            stroke: var(--vscode-textLink-foreground);
            stroke-width: 2;
            transition: opacity 0.2s;
        }
        .connection.hidden {
            opacity: 0.1;
        }
        .legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: var(--vscode-editor-background);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            font-size: 11px;
            z-index: 1000;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
            margin-right: 8px;
        }
        .search-box {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: var(--vscode-editor-background);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .search-box input {
            width: 200px;
        }
        .stats {
            position: absolute;
            top: 10px;
            left: 320px;
            z-index: 1000;
            background: var(--vscode-editor-background);
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="canvas"></div>
        
        <div id="controls">
            <div class="control-group">
                <label>üîç Suche</label>
                <input type="text" id="searchInput" placeholder="Domain, Server, Projekt..." oninput="handleSearch()">
            </div>
            
            <div class="control-group">
                <label>üéØ Filter: Typ</label>
                <div class="filter-mode-toggle">
                    <button id="typeFilterModeMulti" class="active" onclick="setFilterMode('type', 'multi')">Multi</button>
                    <button id="typeFilterModeSingle" onclick="setFilterMode('type', 'single')">Single</button>
                </div>
                <div class="checkbox-group" id="typeFilterGroup">
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-account" checked onchange="handleSingleSelectFilter('type', 'filter-account'); applyFilters()">
                        <label for="filter-account">Accounts</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-project" checked onchange="handleSingleSelectFilter('type', 'filter-project'); applyFilters()">
                        <label for="filter-project">Projekte</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-domain" checked onchange="handleSingleSelectFilter('type', 'filter-domain'); applyFilters()">
                        <label for="filter-domain">Domains</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-server" checked onchange="handleSingleSelectFilter('type', 'filter-server'); applyFilters()">
                        <label for="filter-server">Server</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-record" checked onchange="handleSingleSelectFilter('type', 'filter-record'); applyFilters()">
                        <label for="filter-record">Records</label>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <label>üéØ Filter: Provider</label>
                <div class="filter-mode-toggle">
                    <button id="providerFilterModeMulti" class="active" onclick="setFilterMode('provider', 'multi')">Multi</button>
                    <button id="providerFilterModeSingle" onclick="setFilterMode('provider', 'single')">Single</button>
                </div>
                <div class="checkbox-group" id="providerFilterGroup">
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-provider-all" checked onchange="toggleAllProviders()">
                        <label for="filter-provider-all">Alle Provider</label>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <label>üéØ Filter: Projekt</label>
                <div class="filter-mode-toggle">
                    <button id="projectFilterModeMulti" class="active" onclick="setFilterMode('project', 'multi')">Multi</button>
                    <button id="projectFilterModeSingle" onclick="setFilterMode('project', 'single')">Single</button>
                </div>
                <div class="checkbox-group" id="projectFilterGroup">
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-project-all" checked onchange="toggleAllProjects()">
                        <label for="filter-project-all">Alle Projekte</label>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <label>üîé Zoom</label>
                <div class="zoom-controls">
                    <button onclick="zoomOut()" title="Rauszoomen">-</button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button onclick="zoomIn()" title="Reinzoomen">+</button>
                    <button onclick="resetZoom()" title="Zoom zur√ºcksetzen">Reset</button>
                </div>
            </div>
            
            <div class="control-group">
                <label>üé® Darstellung</label>
                <div class="display-options">
                    <div class="display-option-row">
                        <label>Layout:</label>
                        <select id="layoutMode" onchange="changeLayout()">
                            <option value="hierarchical">Hierarchisch</option>
                            <option value="circular">Kreis</option>
                            <option value="grid">Grid</option>
                            <option value="force">Force-Directed</option>
                        </select>
                    </div>
                    <div class="display-option-row">
                        <label>Node-Gr√∂√üe:</label>
                        <input type="range" id="nodeSize" min="0.5" max="2" step="0.1" value="1" oninput="updateNodeSize(this.value)">
                        <span class="display-option-value" id="nodeSizeValue">100%</span>
                    </div>
                    <div class="display-option-row">
                        <label>Verbindungen:</label>
                        <select id="connectionStyle" onchange="updateConnectionStyle()">
                            <option value="straight">Gerade</option>
                            <option value="curved">Gebogen</option>
                            <option value="dashed">Gestrichelt</option>
                        </select>
                    </div>
                    <div class="display-option-row">
                        <label>Verbindungsst√§rke:</label>
                        <input type="range" id="connectionWidth" min="1" max="5" step="0.5" value="2" oninput="updateConnectionWidth(this.value)">
                        <span class="display-option-value" id="connectionWidthValue">2px</span>
                    </div>
                    <div class="display-option-row">
                        <label>Labels anzeigen:</label>
                        <input type="checkbox" id="showLabels" checked onchange="toggleLabels()">
                    </div>
                    <div class="display-option-row">
                        <label>Node-Farben:</label>
                        <select id="nodeColorMode" onchange="updateNodeColors()">
                            <option value="type">Nach Typ</option>
                            <option value="provider">Nach Provider</option>
                            <option value="project">Nach Projekt</option>
                            <option value="status">Nach Status</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <label>‚öôÔ∏è Ansicht</label>
                <button onclick="resetView()">Reset View</button>
                <button onclick="toggleLayout()">Toggle Layout</button>
                <button onclick="centerView()">Zentrieren</button>
                <button onclick="exportData()">Export JSON</button>
            </div>
        </div>
        
        <div class="search-box">
            <input type="text" id="quickSearch" placeholder="Schnellsuche..." oninput="quickSearch()">
        </div>
        
        <div class="stats" id="stats">
            <span id="statsText">Lade...</span>
        </div>
        
        <div id="legend" class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: var(--vscode-badge-background);"></div>
                <span>Account</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--vscode-textBlockQuote-background);"></div>
                <span>Projekt</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--vscode-textCodeBlock-background);"></div>
                <span>Domain</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--vscode-inputValidation-infoBackground);"></div>
                <span>Server</span>
            </div>
        </div>
    </div>
    <script>
        const vscode = acquireVsCodeApi();
        let graphData = null;
        let layoutMode = 'hierarchical';
        let zoomLevel = 1;
        let panX = 0;
        let panY = 0;
        let isPanning = false;
        let startPanX = 0;
        let startPanY = 0;
        let allNodes = [];
        let allConnections = [];
        let filteredNodes = [];
        let filteredConnections = [];
        let filterModes = { type: 'multi', provider: 'multi', project: 'multi' };
        let nodeSize = 1;
        let connectionStyle = 'straight';
        let connectionWidth = 2;
        let showLabels = true;
        let nodeColorMode = 'type';

        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'updateGraph':
                    graphData = message.data;
                    initializeFilters();
                    renderGraph();
                    break;
            }
        });

        function initializeFilters() {
            if (!graphData) return;
            
            // Populate provider filter
            const providerGroup = document.getElementById('providerFilterGroup');
            const providers = new Set();
            graphData.accounts.forEach(acc => providers.add(acc.provider));
            providers.forEach(prov => {
                const item = document.createElement('div');
                item.className = 'checkbox-item';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `filter-provider-${prov}`;
                checkbox.checked = true;
                checkbox.onchange = () => {
                    handleSingleSelectFilter('provider', checkbox.id);
                    applyFilters();
                };
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = prov;
                item.appendChild(checkbox);
                item.appendChild(label);
                providerGroup.appendChild(item);
            });
            
            // Populate project filter
            const projectGroup = document.getElementById('projectFilterGroup');
            graphData.projects.forEach(proj => {
                const item = document.createElement('div');
                item.className = 'checkbox-item';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `filter-project-${proj.id}`;
                checkbox.checked = true;
                checkbox.onchange = () => {
                    handleSingleSelectFilter('project', checkbox.id);
                    applyFilters();
                };
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = proj.name;
                item.appendChild(checkbox);
                item.appendChild(label);
                projectGroup.appendChild(item);
            });
        }
        
        function toggleAllProviders() {
            const allCheckbox = document.getElementById('filter-provider-all');
            const checkboxes = document.querySelectorAll('#providerFilterGroup input[type="checkbox"]:not(#filter-provider-all)');
            checkboxes.forEach(cb => cb.checked = allCheckbox.checked);
            applyFilters();
        }
        
        function toggleAllProjects() {
            const allCheckbox = document.getElementById('filter-project-all');
            const checkboxes = document.querySelectorAll('#projectFilterGroup input[type="checkbox"]:not(#filter-project-all)');
            checkboxes.forEach(cb => cb.checked = allCheckbox.checked);
            applyFilters();
        }
        
        function setFilterMode(category, mode) {
            filterModes[category] = mode;
            const multiBtn = document.getElementById(`${category}FilterModeMulti`);
            const singleBtn = document.getElementById(`${category}FilterModeSingle`);
            if (mode === 'multi') {
                multiBtn.classList.add('active');
                singleBtn.classList.remove('active');
            } else {
                singleBtn.classList.add('active');
                multiBtn.classList.remove('active');
            }
            applyFilters();
        }
        
        function handleSingleSelectFilter(category, clickedId) {
            if (filterModes[category] !== 'single') return;
            const groupId = `${category}FilterGroup`;
            const checkboxes = document.querySelectorAll(`#${groupId} input[type="checkbox"]`);
            checkboxes.forEach(cb => {
                if (cb.id !== clickedId) {
                    cb.checked = false;
                }
            });
            applyFilters();
        }

        function renderGraph() {
            if (!graphData) return;

            const canvas = document.getElementById('canvas');
            canvas.innerHTML = '';

            allNodes = [];
            allConnections = [];
            let yPos = 50;
            const xSpacing = 200;
            const ySpacing = 100;

            // Render accounts
            graphData.accounts.forEach((account, accIdx) => {
                const x = 50;
                const y = yPos;
                allNodes.push({
                    id: account.id,
                    type: 'account',
                    label: account.name,
                    x, y,
                    provider: account.provider,
                    data: account
                });
                yPos += ySpacing;

                // Render projects for this account
                const accountProjects = graphData.projects.filter(p => 
                    graphData.resources.some(r => r.accountId === account.id && r.projectId === p.id)
                );
                accountProjects.forEach((project, projIdx) => {
                    const px = x + xSpacing;
                    const py = y + (projIdx * 60);
                    allNodes.push({
                        id: project.id,
                        type: 'project',
                        label: project.name,
                        x: px, y: py,
                        projectId: project.id,
                        data: project
                    });
                    allConnections.push({ from: account.id, to: project.id });
                });

                // Render domains
                const accountDomains = graphData.domains.filter(d => d.accountId === account.id);
                accountDomains.forEach((domain, domIdx) => {
                    const dx = x + xSpacing * 2;
                    const dy = y + (domIdx * 50);
                    const domainResource = graphData.resources.find(r => r.id === domain.id && r.providerId === domain.providerId);
                    allNodes.push({
                        id: domain.id,
                        type: 'domain',
                        label: domain.name,
                        x: dx, y: dy,
                        provider: domain.providerId,
                        projectId: domainResource?.projectId,
                        data: domain
                    });
                    allConnections.push({ from: account.id, to: domain.id });

                    if (domainResource?.projectId) {
                        allConnections.push({ from: domainResource.projectId, to: domain.id });
                    }

                    // Render records
                    domain.records.forEach((record, recIdx) => {
                        const rx = dx + xSpacing;
                        const ry = dy + (recIdx * 30);
                        allNodes.push({
                            id: `${domain.id}-${record.id}`,
                            type: 'record',
                            label: `${record.type} ${record.name}`,
                            x: rx, y: ry,
                            provider: domain.providerId,
                            data: record
                        });
                        allConnections.push({ from: domain.id, to: `${domain.id}-${record.id}` });
                    });
                });

                // Render servers
                const accountServers = graphData.servers.filter(s => s.accountId === account.id);
                accountServers.forEach((server, srvIdx) => {
                    const sx = x + xSpacing * 2;
                    const sy = y + (srvIdx * 50) + 200;
                    const serverResource = graphData.resources.find(r => r.id === server.id && r.providerId === server.providerId);
                    allNodes.push({
                        id: server.id,
                        type: 'server',
                        label: server.name,
                        x: sx, y: sy,
                        provider: server.providerId,
                        projectId: serverResource?.projectId,
                        status: server.status,
                        data: server
                    });
                    allConnections.push({ from: account.id, to: server.id });

                    if (serverResource?.projectId) {
                        allConnections.push({ from: serverResource.projectId, to: server.id });
                    }

                    // Link domain records to servers (if IP matches)
                    graphData.domains.forEach(domain => {
                        domain.records.forEach(record => {
                            if ((record.type === 'A' || record.type === 'AAAA') && record.value === server.publicIp) {
                                allConnections.push({ from: `${domain.id}-${record.id}`, to: server.id });
                            }
                        });
                    });
                });
            });

            applyLayout();
            applyFilters();
            updateStats();
        }
        
        function applyLayout() {
            if (layoutMode === 'hierarchical') {
                // Already hierarchical, keep as is
                return;
            }
            
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            const radius = Math.min(window.innerWidth, window.innerHeight) * 0.3;
            
            if (layoutMode === 'circular') {
                // Arrange nodes in a circle
                allNodes.forEach((node, idx) => {
                    const angle = (idx / allNodes.length) * 2 * Math.PI;
                    node.x = centerX + radius * Math.cos(angle);
                    node.y = centerY + radius * Math.sin(angle);
                });
            } else if (layoutMode === 'grid') {
                // Arrange nodes in a grid
                const cols = Math.ceil(Math.sqrt(allNodes.length));
                const cellWidth = 200;
                const cellHeight = 100;
                allNodes.forEach((node, idx) => {
                    const col = idx % cols;
                    const row = Math.floor(idx / cols);
                    node.x = centerX - (cols * cellWidth) / 2 + col * cellWidth;
                    node.y = centerY - (Math.ceil(allNodes.length / cols) * cellHeight) / 2 + row * cellHeight;
                });
            } else if (layoutMode === 'force') {
                // Simple force-directed: spread nodes randomly with some spacing
                allNodes.forEach((node, idx) => {
                    const angle = Math.random() * 2 * Math.PI;
                    const dist = Math.random() * radius;
                    node.x = centerX + dist * Math.cos(angle);
                    node.y = centerY + dist * Math.sin(angle);
                });
            }
        }

        function applyFilters() {
            // Handle single-select mode for type filter
            if (filterModes.type === 'single') {
                const checked = document.querySelectorAll('#typeFilterGroup input[type="checkbox"]:checked');
                if (checked.length > 1) {
                    // If multiple checked in single mode, uncheck all except the last one
                    checked.forEach((cb, idx) => {
                        if (idx < checked.length - 1) cb.checked = false;
                    });
                }
            }
            
            // Get type filters
            const typeFilters = {
                account: document.getElementById('filter-account').checked,
                project: document.getElementById('filter-project').checked,
                domain: document.getElementById('filter-domain').checked,
                server: document.getElementById('filter-server').checked,
                record: document.getElementById('filter-record').checked
            };
            
            // Handle single-select mode for provider filter
            if (filterModes.provider === 'single') {
                const checked = document.querySelectorAll('#providerFilterGroup input[type="checkbox"]:not(#filter-provider-all):checked');
                if (checked.length > 1) {
                    checked.forEach((cb, idx) => {
                        if (idx < checked.length - 1) cb.checked = false;
                    });
                }
            }
            
            // Get provider filters
            const providerFilters = new Set();
            document.querySelectorAll('#providerFilterGroup input[type="checkbox"]:not(#filter-provider-all)').forEach(cb => {
                if (cb.checked) {
                    providerFilters.add(cb.id.replace('filter-provider-', ''));
                }
            });
            const allProviders = document.getElementById('filter-provider-all').checked || filterModes.provider === 'single';
            
            // Handle single-select mode for project filter
            if (filterModes.project === 'single') {
                const checked = document.querySelectorAll('#projectFilterGroup input[type="checkbox"]:not(#filter-project-all):checked');
                if (checked.length > 1) {
                    checked.forEach((cb, idx) => {
                        if (idx < checked.length - 1) cb.checked = false;
                    });
                }
            }
            
            // Get project filters
            const projectFilters = new Set();
            document.querySelectorAll('#projectFilterGroup input[type="checkbox"]:not(#filter-project-all)').forEach(cb => {
                if (cb.checked) {
                    projectFilters.add(cb.id.replace('filter-project-', ''));
                }
            });
            const allProjects = document.getElementById('filter-project-all').checked || filterModes.project === 'single';
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            filteredNodes = allNodes.filter(node => {
                // Type filter
                if (!typeFilters[node.type]) return false;
                
                // Provider filter
                if (!allProviders && node.provider && !providerFilters.has(node.provider)) return false;
                
                // Project filter
                if (!allProjects && node.projectId && !projectFilters.has(node.projectId)) return false;
                
                // Search filter
                if (searchTerm && !node.label.toLowerCase().includes(searchTerm)) return false;
                
                return true;
            });

            // Filter connections to only show connections between visible nodes
            const visibleNodeIds = new Set(filteredNodes.map(n => n.id));
            filteredConnections = allConnections.filter(conn => 
                visibleNodeIds.has(conn.from) && visibleNodeIds.has(conn.to)
            );

            renderFilteredGraph();
        }

        function renderFilteredGraph() {
            const canvas = document.getElementById('canvas');
            canvas.innerHTML = '';

            // Create SVG for connections (behind nodes)
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.id = 'connections-svg';
            svg.style.position = 'absolute';
            svg.style.top = '0';
            svg.style.left = '0';
            svg.style.width = '100%';
            svg.style.height = '100%';
            svg.style.pointerEvents = 'none';
            svg.style.zIndex = '1';
            canvas.appendChild(svg);

            // Render nodes first (so they're on top)
            filteredNodes.forEach(node => {
                const nodeEl = document.createElement('div');
                nodeEl.className = `node node-${node.type}`;
                if (showLabels) {
                    nodeEl.textContent = node.label;
                } else {
                    nodeEl.textContent = '';
                    nodeEl.title = node.label;
                }
                nodeEl.setAttribute('data-node-id', node.id);
                nodeEl.style.position = 'absolute';
                nodeEl.style.left = node.x + 'px';
                nodeEl.style.top = node.y + 'px';
                nodeEl.style.zIndex = '10';
                nodeEl.style.transform = `scale(${nodeSize})`;
                nodeEl.style.transformOrigin = 'center';
                
                // Apply color mode
                if (nodeColorMode === 'provider' && node.provider) {
                    nodeEl.style.backgroundColor = getProviderColor(node.provider);
                } else if (nodeColorMode === 'project' && node.projectId) {
                    nodeEl.style.backgroundColor = getProjectColor(node.projectId);
                } else if (nodeColorMode === 'status' && node.status) {
                    nodeEl.style.backgroundColor = getStatusColor(node.status);
                }
                
                nodeEl.onclick = () => {
                    vscode.postMessage({
                        command: 'nodeClick',
                        nodeId: node.id,
                        nodeType: node.type
                    });
                };
                canvas.appendChild(nodeEl);
            });

            // Render connections after nodes (so they appear behind)
            filteredConnections.forEach(conn => {
                const fromNode = filteredNodes.find(n => n.id === conn.from);
                const toNode = filteredNodes.find(n => n.id === conn.to);
                if (!fromNode || !toNode) return;

                const x1 = fromNode.x + 50;
                const y1 = fromNode.y + 20;
                const x2 = toNode.x + 50;
                const y2 = toNode.y + 20;
                
                if (connectionStyle === 'curved') {
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const midX = (x1 + x2) / 2;
                    const midY = (y1 + y2) / 2;
                    const curveOffset = 30;
                    const d = `M ${x1} ${y1} Q ${midX} ${midY - curveOffset}, ${x2} ${y2}`;
                    path.setAttribute('d', d);
                    path.setAttribute('fill', 'none');
                    path.setAttribute('stroke', 'var(--vscode-textLink-foreground)');
                    path.setAttribute('stroke-width', connectionWidth);
                    path.setAttribute('opacity', '0.6');
                    svg.appendChild(path);
                } else {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', x1);
                    line.setAttribute('y1', y1);
                    line.setAttribute('x2', x2);
                    line.setAttribute('y2', y2);
                    line.setAttribute('stroke', 'var(--vscode-textLink-foreground)');
                    line.setAttribute('stroke-width', connectionWidth);
                    line.setAttribute('opacity', '0.6');
                    if (connectionStyle === 'dashed') {
                        line.setAttribute('stroke-dasharray', '5,5');
                    }
                    svg.appendChild(line);
                }
            });

            updateTransform();
        }

        function updateTransform() {
            const canvas = document.getElementById('canvas');
            canvas.style.transform = `translate(${panX}px, ${panY}px) scale(${zoomLevel})`;
            document.getElementById('zoomLevel').textContent = Math.round(zoomLevel * 100) + '%';
            
            // Update SVG transform to match canvas
            const svg = document.getElementById('connections-svg');
            if (svg) {
                svg.style.transform = `translate(${panX}px, ${panY}px) scale(${zoomLevel})`;
                svg.style.transformOrigin = '0 0';
            }
        }

        function zoomIn() {
            zoomLevel = Math.min(zoomLevel * 1.2, 3);
            updateTransform();
        }

        function zoomOut() {
            zoomLevel = Math.max(zoomLevel / 1.2, 0.1);
            updateTransform();
        }

        function resetZoom() {
            zoomLevel = 1;
            panX = 0;
            panY = 0;
            updateTransform();
        }

        function centerView() {
            if (filteredNodes.length === 0) return;
            const bounds = filteredNodes.reduce((acc, node) => {
                return {
                    minX: Math.min(acc.minX, node.x),
                    maxX: Math.max(acc.maxX, node.x),
                    minY: Math.min(acc.minY, node.y),
                    maxY: Math.max(acc.maxY, node.y)
                };
            }, { minX: Infinity, maxX: -Infinity, minY: Infinity, maxY: -Infinity });

            const centerX = (bounds.minX + bounds.maxX) / 2;
            const centerY = (bounds.minY + bounds.maxY) / 2;
            panX = window.innerWidth / 2 - centerX * zoomLevel;
            panY = window.innerHeight / 2 - centerY * zoomLevel;
            updateTransform();
        }

        function handleSearch() {
            applyFilters();
        }

        function quickSearch() {
            const term = document.getElementById('quickSearch').value.toLowerCase();
            const canvas = document.getElementById('canvas');
            
            if (!term) {
                canvas.querySelectorAll('.node.highlighted').forEach(el => {
                    el.classList.remove('highlighted');
                });
                return;
            }

            filteredNodes.forEach(node => {
                const matches = node.label.toLowerCase().includes(term);
                const nodeEl = canvas.querySelector(`[data-node-id="${node.id}"]`);
                if (nodeEl) {
                    if (matches) {
                        nodeEl.classList.add('highlighted');
                    } else {
                        nodeEl.classList.remove('highlighted');
                    }
                }
            });
        }

        function resetView() {
            resetZoom();
            // Reset filter modes
            filterModes = { type: 'multi', provider: 'multi', project: 'multi' };
            document.getElementById('typeFilterModeMulti').classList.add('active');
            document.getElementById('typeFilterModeSingle').classList.remove('active');
            document.getElementById('providerFilterModeMulti').classList.add('active');
            document.getElementById('providerFilterModeSingle').classList.remove('active');
            document.getElementById('projectFilterModeMulti').classList.add('active');
            document.getElementById('projectFilterModeSingle').classList.remove('active');
            // Reset type filters
            document.getElementById('filter-account').checked = true;
            document.getElementById('filter-project').checked = true;
            document.getElementById('filter-domain').checked = true;
            document.getElementById('filter-server').checked = true;
            document.getElementById('filter-record').checked = true;
            // Reset provider filters
            document.getElementById('filter-provider-all').checked = true;
            document.querySelectorAll('#providerFilterGroup input[type="checkbox"]:not(#filter-provider-all)').forEach(cb => cb.checked = true);
            // Reset project filters
            document.getElementById('filter-project-all').checked = true;
            document.querySelectorAll('#projectFilterGroup input[type="checkbox"]:not(#filter-project-all)').forEach(cb => cb.checked = true);
            // Reset display options
            layoutMode = 'hierarchical';
            document.getElementById('layoutMode').value = 'hierarchical';
            nodeSize = 1;
            document.getElementById('nodeSize').value = 1;
            document.getElementById('nodeSizeValue').textContent = '100%';
            connectionStyle = 'straight';
            document.getElementById('connectionStyle').value = 'straight';
            connectionWidth = 2;
            document.getElementById('connectionWidth').value = 2;
            document.getElementById('connectionWidthValue').textContent = '2px';
            showLabels = true;
            document.getElementById('showLabels').checked = true;
            nodeColorMode = 'type';
            document.getElementById('nodeColorMode').value = 'type';
            document.getElementById('searchInput').value = '';
            document.getElementById('quickSearch').value = '';
            renderGraph();
        }

        function toggleLayout() {
            layoutMode = layoutMode === 'hierarchical' ? 'force' : 'hierarchical';
            document.getElementById('layoutMode').value = layoutMode;
            renderGraph();
        }
        
        function changeLayout() {
            layoutMode = document.getElementById('layoutMode').value;
            renderGraph();
        }
        
        function updateNodeSize(value) {
            nodeSize = parseFloat(value);
            document.getElementById('nodeSizeValue').textContent = Math.round(nodeSize * 100) + '%';
            renderFilteredGraph();
        }
        
        function updateConnectionStyle() {
            connectionStyle = document.getElementById('connectionStyle').value;
            renderFilteredGraph();
        }
        
        function updateConnectionWidth(value) {
            connectionWidth = parseFloat(value);
            document.getElementById('connectionWidthValue').textContent = connectionWidth + 'px';
            renderFilteredGraph();
        }
        
        function toggleLabels() {
            showLabels = document.getElementById('showLabels').checked;
            renderFilteredGraph();
        }
        
        function updateNodeColors() {
            nodeColorMode = document.getElementById('nodeColorMode').value;
            renderFilteredGraph();
        }
        
        function getProviderColor(provider) {
            const colors = {
                'ionos-dns': '#0066cc',
                'hetzner-cloud': '#d50c2d',
                'cloudflare': '#f38020',
                'google-dns': '#4285f4',
                'aws-route53': '#ff9900'
            };
            return colors[provider] || 'var(--vscode-badge-background)';
        }
        
        function getProjectColor(projectId) {
            if (!graphData) return 'var(--vscode-textBlockQuote-background)';
            const project = graphData.projects.find(p => p.id === projectId);
            return project?.color || 'var(--vscode-textBlockQuote-background)';
        }
        
        function getStatusColor(status) {
            const colors = {
                'running': '#4caf50',
                'off': '#f44336',
                'migrating': '#ff9800',
                'unknown': '#9e9e9e'
            };
            return colors[status] || 'var(--vscode-inputValidation-infoBackground)';
        }

        function exportData() {
            if (graphData) {
                const json = JSON.stringify(graphData, null, 2);
                vscode.postMessage({
                    command: 'exportData',
                    data: json
                });
            }
        }

        function updateStats() {
            const stats = {
                total: allNodes.length,
                visible: filteredNodes.length,
                accounts: allNodes.filter(n => n.type === 'account').length,
                projects: allNodes.filter(n => n.type === 'project').length,
                domains: allNodes.filter(n => n.type === 'domain').length,
                servers: allNodes.filter(n => n.type === 'server').length,
                records: allNodes.filter(n => n.type === 'record').length
            };
            document.getElementById('statsText').textContent = 
                `${stats.visible}/${stats.total} sichtbar | ` +
                `A:${stats.accounts} P:${stats.projects} D:${stats.domains} S:${stats.servers} R:${stats.records}`;
        }

        // Pan with mouse drag
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;

        document.getElementById('map-container').addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('node')) return;
            isDragging = true;
            dragStartX = e.clientX - panX;
            dragStartY = e.clientY - panY;
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            panX = e.clientX - dragStartX;
            panY = e.clientY - dragStartY;
            updateTransform();
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        // Zoom with mouse wheel
        document.getElementById('map-container').addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            zoomLevel = Math.max(0.1, Math.min(3, zoomLevel * delta));
            updateTransform();
        });

        // Request initial data
        vscode.postMessage({ command: 'requestData' });
    </script>
</body>
</html>
